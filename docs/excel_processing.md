# وثيقة تدفق معالجة Excel — أولوية 4/5

## ما يحدث بعد رفع الملف
1) التحقق من الامتداد والصلاحية.
2) قراءة الملف عبر SheetJS وتحويله إلى JSON داخلي.
3) اكتشاف الأعمدة وتطبيق column mapping قابل للحفظ إلى الحقول القياسية (bank, supplier, guarantee_no, contract_no, amount, date).
4) تنظيف القيم وتطبيعها (حروف، فراغات، رموز).
5) إذا تعذر تعيين الحقول الإلزامية، يُرفض الملف برسالة واضحة (انظر `docs/excel_template.md`).
6) التحقق من الترميز: محاولة القراءة بـ UTF-8؛ إذا ظهرت أحرف مربعة/مشوهة تُعاد المحاولة باعتبار CP1256.

### قواعد اكتشاف الأعمدة (أمثلة اسم العمود)
- bank: `bank`, `البنك`, `Bank Name`
- supplier: `supplier`, `vendor`, `المورد`, `المتعهد`
- guarantee_no: `guarantee_no`, `guarantee`, `bond_no`, `رقم الضمان`
- contract_no: `contract`, `contract_no`, `رقم العقد`
- amount: `amount`, `value`, `المبلغ`
- date: `date`, `expiry`, `renewal`, `تاريخ الانتهاء`
- الحساسية لحالة الأحرف غير ضرورية؛ يسمح بالتطابق الجزئي بعد التطبيع.

## شكل التحويل لكل سطر (مثال)
```json
{
  "bank_raw": "...",
  "supplier_raw": "...",
  "guarantee_no": "...",
  "contract_no": "...",
  "amount_raw": "...",
  "renewal_date_raw": "..."
}
```

## التنبيهات المحتملة
- أعمدة مفقودة أو غير معروفة.
- صفوف ناقصة حقول رئيسية.
- تواريخ أو أرقام غير قابلة للقراءة.
- تشفير غير متوقع (مثلاً CP1256) يؤدي لرموز غير مفهومة → اطلب إعادة حفظ الملف بـ UTF-8/Excel قياسي.
سلوك كشف الأعمدة:
- تطابق تام، ثم تطابق lowercase، ثم تطابق عربي مُطبّع (إزالة تشكيل/مسافات).
- قائمة مرادفات صريحة لكل حقل (انظر `docs/excel_template.md`).

## أخطاء الاستيراد ومعالجتها
- ملف غير مدعوم: إظهار رسالة واضحة ورفض التحميل.
- أعمدة غير مكتشفة: طلب تأكيد/تعيين يدوي للأعمدة مع حفظ الاختيار.
- بيانات غير صالحة: وضع الصفوف في قائمة مراجعة لإصلاحها أو استبعادها.
- أرقام مخزنة كنص: تحويل آمن مع التحقق من الرموز (`,` أو `.` أو مسافات).
- تواريخ كنص: محاولة التحويل ثم إبراز الصف للمراجعة إذا فشل التحليل.
- mapping مريب (عمود واحد مخصص لحقلين): إظهار تحذير أحمر وفرض تعديل يدوي قبل المتابعة.

## المخرجات
- JSON موحّد يُمرَّر إلى خوارزميات التطابق والبناء اللاحق للخطاب.
- مرجع توثيقي: راجع `docs/excel_template.md` لجدول الحقول الإلزامية وأمثلة الأعمدة.
