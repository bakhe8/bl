# وثيقة خوارزميات التطابق — أولوية 4/5

## طبقات التطابق
(راجع أيضًا: [dictionaries.md](dictionaries.md) لمصادر القواميس)
1) البنوك: تطابق رسمي/اختصار فقط ضد القاموس الرسمي (`banks.json`) + Fuzzy Jaro-Winkler ≥ 0.9 (لا تعلّم للبنوك).
2) الموردون: تطابق رسمي، ثم variants المتعلمة (LocalStorage + بذرة `variants_suppliers.json`)، ثم Fuzzy:
   - ≥ 0.90 اعتماد تلقائي (status=auto).
   - 0.80–0.89 اقتراح للمستخدم (status=fuzzy).
   - < 0.80 قرار يدوي (status=manual).

## إدارة الغموض
- البنوك غير المعروفة: رسالة تنبيه “اسم البنك غير معروف – اختر من القائمة الرسمية”.
- الموردون غير المحسومين: عرض في واجهة القرارات مع اقتراح Fuzzy إن وجد.
- عند تعدد تطابقات متقاربة: عرض مرتّب بالثقة؛ لا قبول تلقائي تحت 0.80.

## حفظ القرار
- الموردون فقط: قرار المستخدم يحفظ alias في LocalStorage (`bgl_supplier_variants`)، مع score يعتمد التشابه + التكرار + القرارات اليدوية.
- ترقية variant: score ≥ 0.92 أو occurrences ≥ 3 → confirmed = true → لا يظهر مجددًا في قائمة القرارات.

## شكل تخزين variant (مثال)
```json
"cure dev": {
  "official": "شركة كير للتطوير",
  "occurrences": 3,
  "confirmed": true,
  "status": "confirmed",
  "manualCount": 1,
  "autoCount": 0,
  "score": 0.95,
  "lastSeenAt": "2025-11-21T20:00:00.000Z"
}
```

## جودة التطابق
- حد أدنى للتشابه قبل اعتماد Fuzzy (Jaro-Winkler).
- استخدام سياق إضافي (مبلغ/تاريخ/رقم ضمان) للمساعدة في القرار اليدوي عند اللزوم.
- رفض أسماء عشوائية/قصيرة جدًا قبل التعلّم لضمان جودة القاموس.
- حالات التعلّم للموردين: tentative → semi → confirmed → permanent حسب score/occurrences (لا تنطبق على البنوك).
